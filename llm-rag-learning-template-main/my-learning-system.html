<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ç§ã®å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ </title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        header p { font-size: 1.2em; opacity: 0.9; }
        .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 { color: #667eea; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #667eea; }
        .input-group { margin-bottom: 15px; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;
            transition: border-color 0.3s;
        }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #667eea; }
        button {
            background: #667eea; color: white; border: none; padding: 12px 24px;
            border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s;
        }
        button:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        #response-area {
            margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;
            min-height: 100px; display: none;
        }
        #response-area.show { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar-section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .sidebar-section h3 { color: #667eea; margin-bottom: 10px; }

        /* â–¼ ç›®æ¨™é”æˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè¿½åŠ ï¼‰ */
        .fade-in {
            animation: fadeInGoal 0.9s cubic-bezier(.2,.9,.3,1);
        }
        @keyframes fadeInGoal {
            0% { transform: scale(0.85); opacity: 0; box-shadow: 0 0 0 rgba(255,255,255,0); }
            40% { transform: scale(1.08); opacity: 1; box-shadow: 0 0 28px rgba(255,215,64,0.85); }
            80% { transform: scale(1.02); box-shadow: 0 0 12px rgba(255,215,64,0.6); }
            100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,255,255,0); }
        }

        #goal-progress-container { background:#e0e0e0; border-radius: 8px; overflow:hidden; height: 20px; }
        #goal-progress-bar { background:#28a745; width:0%; height:100%; transition: width 0.5s; }

        @media (max-width: 800px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>

<body>
<div class="container">
    <header>
        <h1>ğŸ“ ç§ã®å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>LLM Ã— RAG Ã— ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã§ä½œã‚‹ã€è‡ªåˆ†å°‚ç”¨ã®å­¦ç¿’ãƒ„ãƒ¼ãƒ«</p>
    </header>

    <div class="main-grid">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="card">
            <h2>ğŸ’¬ è³ªå•ãƒ»å­¦ç¿’ã‚¨ãƒªã‚¢</h2>
            <div class="input-group">
                <input type="text" id="question-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                    onkeypress="if(event.key==='Enter') processQuestion()" />
            </div>
            <button onclick="processQuestion()">è³ªå•ã™ã‚‹</button>
            <button onclick="clearResponse()" style="background: #6c757d;">ã‚¯ãƒªã‚¢</button>
            <div id="response-area"></div>

            <div id="custom-features" style="margin-top: 30px;">
                <button onclick="experimentPrompts()">ğŸ’¡ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå®Ÿé¨“ (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«)</button>
                <button onclick="experimentSearch()">ğŸ” æ¤œç´¢æ¯”è¼ƒ (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«)</button>
                <button onclick="experimentOntology()">ğŸ“– ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼å®Ÿé¨“ (ã‚³ãƒ³ã‚½ãƒ¼ãƒ«)</button>
            </div>

            <div class="input-group" style="margin-top:20px;">
                <label>ç†è§£åº¦: <span id="score-display">50</span>%</label>
                <input type="range" id="score-slider" min="0" max="100" value="50"
                    oninput="document.getElementById('score-display').innerText=this.value"/>
            </div>

            <button onclick="saveRecord()" style="background:#28a745; margin-top:10px;">è¨˜éŒ²ã™ã‚‹</button>
            <button onclick="resetHistory()" style="background:#dc3545; margin-top:10px;">å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

            <div id="history-area" style="margin-top:20px;"></div>

            <h3>ğŸ“ˆ å­¦ç¿’é€²æ—</h3>
            <canvas id="progressChart" width="400" height="200"></canvas>
        </div>

        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div>
            <div class="card">
                <h2>ğŸ“Š æƒ…å ±ãƒ‘ãƒãƒ«</h2>
                <div class="sidebar-section">
                    <h3>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                    <div id="system-status">åˆæœŸåŒ–ä¸­...</div>
                </div>
                <div class="sidebar-section">
                    <h3>çµ±è¨ˆæƒ…å ±</h3>
                    <div id="statistics">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
                </div>
                <div class="sidebar-section">
                    <h3>è‹¦æ‰‹ãªåˆ†é‡</h3>
                    <div id="weak-concepts">ãªã—</div>
                </div>

                <div id="goal-box" class="sidebar-section">
                    <h3>ğŸ¯ å­¦ç¿’ç›®æ¨™</h3>
                    <div class="input-group">
                        <input type="text" id="goal-input" placeholder="ä»Šé€±ã®ç›®æ¨™ã‚’å…¥åŠ›..." />
                    </div>
                    <button onclick="setLearningGoal()" style="background:#ffc107; margin-bottom: 10px;">
                        ç›®æ¨™ã‚’è¨­å®š
                    </button>
                    <div id="goal-display" style="margin-top: 10px; font-weight: bold;"></div>
                    <div id="goal-progress-container" style="margin-top:10px;">
                        <div id="goal-progress-bar"></div>
                    </div>
                    <button onclick="resetGoal()" style="background:#17a2b8; margin-top:10px;">ç›®æ¨™ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
                </div>

                <div id="custom-sidebar"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="js/config.js"></script>
<script src="js/llm-client.js"></script>
<script src="js/vector-search.js"></script>
<script src="js/ontology.js"></script>
<script src="js/concept-extractor.js"></script>
<script src="js/semantic-rag.js"></script>

<script>
class LearningTracker {
    constructor() {
        this.history = JSON.parse(localStorage.getItem('learningHistory') || '[]');
    }
    addRecord(question, answer, understanding, answerConcepts=[]) {
        this.history.push({
            timestamp: new Date().toISOString(),
            question,
            answer,
            understanding,
            answerConcepts
        });
        localStorage.setItem('learningHistory', JSON.stringify(this.history));
    }
    getHistory() { return this.history; }
}

const tracker = new LearningTracker();

function renderHistory() {
    const area = document.getElementById('history-area');
    const history = tracker.getHistory();
    if (history.length === 0) {
        area.innerHTML = "<p>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>";
        return;
    }
    area.innerHTML = history
        .map(r => `
            <div class="record-card" style="
                background:white; padding:10px; border-radius:10px; margin-bottom:10px;
                box-shadow:0 3px 6px rgba(0,0,0,0.1);
            ">
                <p><strong>ğŸ“˜ è³ªå•:</strong> ${r.question}</p>
                <p><strong>ğŸ’¡ ç†è§£åº¦:</strong> ${r.understanding}%</p>
                <p><strong>â° æ—¥æ™‚:</strong> ${new Date(r.timestamp).toLocaleString()}</p>
                <p><strong>ğŸ”— æ¦‚å¿µ:</strong> ${r.answerConcepts?.join(', ') || 'ãªã—'}</p>
            </div>
        `).join('');
}

let progressChart = null;
function renderProgressChart() {
    const history = tracker.getHistory();
    if (history.length === 0) return;
    const labels = history.map((r,i)=>`Q${i+1}`);
    const data = history.map(r=>Number(r.understanding));
    const ctx = document.getElementById('progressChart').getContext('2d');
    if(progressChart){
        progressChart.data.labels = labels;
        progressChart.data.datasets[0].data = data;
        progressChart.update();
    } else {
        progressChart = new Chart(ctx,{
            type:'line',
            data:{
                labels:labels,
                datasets:[{
                    label:'ç†è§£åº¦',
                    data:data,
                    backgroundColor:'rgba(102,126,234,0.2)',
                    borderColor:'rgba(102,126,234,1)',
                    borderWidth:2,
                    tension:0.3
                }]
            },
            options:{
                scales:{y:{min:0,max:100}}
            }
        });
    }
}

function getWeakConcepts() {
    const history = tracker.getHistory();
    const conceptScores = {};
    history.forEach(r=>{
        const concepts = r.answerConcepts || [];
        concepts.forEach(c=>{
            if(!conceptScores[c]) conceptScores[c]=[];
            conceptScores[c].push(Number(r.understanding));
        });
    });
    const weakConcepts=[];
    for(const c in conceptScores){
        const avg=conceptScores[c].reduce((a,b)=>a+b,0)/conceptScores[c].length;
        if(avg<60) weakConcepts.push({concept:c,avg});
    }
    return weakConcepts;
}

function updateWeakConcepts() {
    const weakConcepts = getWeakConcepts();
    const container = document.getElementById('weak-concepts');
    if(!container) return;
    const customLabels={
        "japanese-food":"æ—¥æœ¬é£Ÿ",
        "cooking-basics":"æ–™ç†åŸºç¤",
        "ball-handling":"ãƒœãƒ¼ãƒ«æ“ä½œ",
        "coordination":"å”èª¿é‹å‹•"
    };
    if(weakConcepts.length===0){
        container.innerHTML="<p>è‹¦æ‰‹ãªåˆ†é‡ã¯ã‚ã‚Šã¾ã›ã‚“</p>";
    } else {
        container.innerHTML = weakConcepts.map(c=>{
            const label = semanticRAG?.ontology?.getConcept(c.concept)?.label || customLabels[c.concept] || c.concept;
            return `${label}ï¼ˆå¹³å‡ ${c.avg.toFixed(1)}%ï¼‰`;
        }).join('<br>');
    }
}

/* å­¦ç¿’ç›®æ¨™ */
let currentGoal = localStorage.getItem('learningGoal') || '';
let goalProgress = Number(localStorage.getItem('goalProgress') || 0);

function setLearningGoal(){
    const input=document.getElementById('goal-input').value.trim();
    if(!input) return alert('ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
    currentGoal=input; goalProgress=0;
    localStorage.setItem('learningGoal',currentGoal);
    localStorage.setItem('goalProgress',goalProgress);
    updateGoalDisplay();
}

function updateGoalDisplay(){
    document.getElementById('goal-display').innerText=currentGoal?`ç›®æ¨™: ${currentGoal}`:'';
    updateGoalProgressBar();
}

function updateGoalProgressBar(){
    const bar=document.getElementById('goal-progress-bar');
    bar.style.width=`${goalProgress}%`;
    const goalBox=document.getElementById('goal-box');
    if(goalProgress>=100){
        goalProgress=100;
        bar.style.width='100%';
        localStorage.setItem('goalProgress',goalProgress);
        goalBox?.classList.remove('fade-in');
        void goalBox?.offsetWidth;
        goalBox?.classList.add('fade-in');
        setTimeout(()=>{alert(`ğŸ‰ ç›®æ¨™ã€Œ${currentGoal}ã€ã‚’é”æˆã—ã¾ã—ãŸï¼`);},900);
    }
}

function updateGoalProgress(understanding){
    if(!currentGoal) return;
    if(understanding===undefined) understanding=Number(document.getElementById('score-slider').value);
    goalProgress+=understanding/5;
    if(goalProgress>100) goalProgress=100;
    localStorage.setItem('goalProgress',goalProgress);
    updateGoalProgressBar();
}

function resetGoal(){
    if(!confirm("æœ¬å½“ã«å­¦ç¿’ç›®æ¨™ã¨é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
    currentGoal=''; goalProgress=0;
    localStorage.removeItem('learningGoal');
    localStorage.removeItem('goalProgress');
    updateGoalDisplay();
    alert("âœ… å­¦ç¿’ç›®æ¨™ã¨é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
}

/* saveRecord */
function saveRecord(){
    const question=document.getElementById('question-input').value;
    const answer=document.getElementById('response-area').innerText;
    const understanding=Number(document.getElementById('score-slider').value);
    if(!question || !answer){ alert("è³ªå•ã—ã¦å›ç­”ã‚’ç”Ÿæˆã—ã¦ã‹ã‚‰è¨˜éŒ²ã—ã¦ãã ã•ã„ï¼"); return;}
    const answerConcepts = lastAnswerConcepts || [];
    tracker.addRecord(question,answer,understanding,answerConcepts);
    renderHistory(); renderProgressChart(); updateWeakConcepts();
    updateGoalProgress(understanding);
}

/* å±¥æ­´ãƒªã‚»ãƒƒãƒˆ */
function resetHistory(){
    if(!confirm("æœ¬å½“ã«å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem('learningHistory'); tracker.history=[];
    renderHistory(); renderProgressChart(); updateWeakConcepts();
    alert("âœ… å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
}

let semanticRAG=null; let questionCount=0; let lastAnswerConcepts=[];

async function initialize(){
    console.log("ğŸŒ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...");
    semanticRAG = new SemanticRAGSystem();
    try{
        const ontologyRes=await fetch("data/learning-ontology.json");
        if(!ontologyRes.ok) throw new Error("ã‚ªãƒ³ãƒˆãƒ­ã‚¸ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—");
        const ontologyData=await ontologyRes.json();

        const docsRes=await fetch("data/sample-documents.json");
        if(!docsRes.ok) throw new Error("æ–‡æ›¸ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—");
        const docsJson=await docsRes.json();
        const documents=docsJson.documents;

        await semanticRAG.initialize(documents,ontologyData);

        window.ragSystem = semanticRAG;
        updateStatus("ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº† âœ…");
    }catch(error){
        console.error(error);
        updateStatus("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ âŒ");
    }
}

async function processQuestion(){
    if(!semanticRAG){alert("âŒ ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return;}
    const input=document.getElementById('question-input');
    const question=input.value.trim();
    if(!question){alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return;}
    const responseArea=document.getElementById('response-area');
    responseArea.className='show';
    responseArea.innerHTML='<p>ğŸ¤” è€ƒãˆä¸­...</p>';
    try{
        const result=await semanticRAG.semanticQuery(question);
        const concepts=result.conceptsUsed||[];
        const sources=result.sources||[];
        lastAnswerConcepts=concepts;
        responseArea.innerHTML=`
            <h3>ğŸ’¡ å›ç­”</h3>
            <p>${result.answer || "ãªã—"}</p>
            <h4 style="margin-top:15px;">ğŸ”— é–¢é€£æ¦‚å¿µ</h4>
            <p>${concepts.join(', ') || "ãªã—"}</p>
            <h4 style="margin-top:15px;">ğŸ“š å‚è€ƒæ–‡æ›¸</h4>
            <p>${sources.length}ä»¶ã®æ–‡æ›¸ã‚’å‚ç…§ã—ã¾ã—ãŸ</p>
        `;
        questionCount++;
        updateStatistics();
    }catch(error){
        responseArea.innerHTML=`<p style="color:red;">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
    }
}

function clearResponse(){document.getElementById('response-area').className='';document.getElementById('question-input').value='';}
function updateStatus(message){document.getElementById('system-status').innerHTML=`<p style="padding:10px;background:white;border-radius:5px;">${message}</p>`;}
function updateStatistics(){document.getElementById('statistics').innerHTML=`<p style="padding:10px;background:white;border-radius:5px;">è³ªå•æ•°: ${questionCount}å›<br></p>`;}

window.onload=()=>{
    initialize(); renderHistory(); renderProgressChart(); updateWeakConcepts(); updateGoalDisplay();
};
</script>

</body>
</html>
